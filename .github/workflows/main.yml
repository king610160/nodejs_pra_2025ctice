jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1 & 2 ä¿æŒä¸è®Š (èªè­‰å’Œ Checkout)
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ğŸŒŸ Step 3: ä½¿ç”¨ AWS SSM Action åŸ·è¡Œé ç«¯è…³æœ¬ (æœ€ç©©å®šçš„æ–¹å¼)
      - name: Execute Smart Deployment Script on EC2 via Action
        uses: peterjgrainger/aws-ssm-send-command@v2
        id: ssm_deploy
        with:
          instance_ids: '${{ secrets.EC2_INSTANCE_ID }}'
          aws_region: '${{ secrets.AWS_REGION }}'
          # ğŸš¨ é—œéµï¼šå°‡æ•´å€‹å¤šè¡Œè…³æœ¬ç›´æ¥å‚³çµ¦ commands åƒæ•¸
          commands: |
            PROJECT_DIR=/home/ec2-user/simple_router
            SERVICE_NAME=simple-router
            REPO_URL=https://github.com/${{ github.repository }}.git
            
            # --- å®Œæ•´çš„ã€ä¹¾æ·¨çš„ Bash è…³æœ¬ ---
            # å¿…é ˆä½¿ç”¨ sudo -u ec2-user åŸ·è¡Œï¼Œä»¥ç¢ºä¿æª”æ¡ˆæ¬Šé™æ­£ç¢º
            sudo -u ec2-user bash << EOF
            
            # 1. NVM/Node ç’°å¢ƒè¨­ç½®
            export NVM_DIR="/home/ec2-user/.nvm"
            [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
            nvm use node
            
            # 2. åˆ¤æ–·é‚è¼¯
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "--- åŸ·è¡Œé¦–æ¬¡éƒ¨ç½² (Initial Deployment) ---"
              git clone "$REPO_URL" "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              npm install
              pm2 start index.js --name "$SERVICE_NAME"
              pm2 save
            else
              echo "--- åŸ·è¡Œç¨‹å¼ç¢¼æ›´æ–° (Update Deployment) ---"
              cd "$PROJECT_DIR"
              git pull origin main
              npm install
              pm2 reload "$SERVICE_NAME"
            fi
            echo "--- éƒ¨ç½²å®Œæˆ ---"
            
            EOF