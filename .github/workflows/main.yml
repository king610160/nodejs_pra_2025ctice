name: Node.js EC2 Deployment via SSM

# ç¢ºä¿é€™éƒ¨åˆ†åœ¨æ–‡ä»¶é–‹é ­ï¼Œä¸”ç¸®æ’æ­£ç¢º
on:
  push:
    branches:
      - main
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: æª¢æŸ¥ç¨‹å¼ç¢¼ (ä¿æŒä¸è®Š)
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: èªè­‰ (ä¿æŒä¸è®Š)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ğŸŒŸ Step 3: ä½¿ç”¨ AWS å®˜æ–¹ SSM Action åŸ·è¡Œé ç«¯è…³æœ¬
      - name: Execute Smart Deployment Script on EC2 via Official AWS Action
        uses: aws-actions/aws-ssm-send-command@v1 # å®˜æ–¹ Action
        id: ssm_deploy
        with:
          instance-ids: '${{ secrets.EC2_INSTANCE_ID }}'
          document-name: 'AWS-RunShellScript'
          
          # é—œéµï¼šå°‡æ•´å€‹å¤šè¡Œè…³æœ¬ç›´æ¥å‚³çµ¦ parameters åƒæ•¸ (Action æœƒè² è²¬æ‰“åŒ…)
          parameters: |
            commands: |
              PROJECT_DIR=/home/ec2-user/simple_router
              SERVICE_NAME=simple-router
              REPO_URL=https://github.com/${{ github.repository }}.git
              
              # --- å®Œæ•´çš„ã€ä¹¾æ·¨çš„ Bash è…³æœ¬ ---
              # å¿…é ˆä½¿ç”¨ sudo -u ec2-user åŸ·è¡Œï¼Œä»¥ç¢ºä¿æª”æ¡ˆæ¬Šé™æ­£ç¢º
              sudo -u ec2-user bash << EOF
              
              # 1. NVM/Node ç’°å¢ƒè¨­ç½®
              export NVM_DIR="/home/ec2-user/.nvm"
              [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
              nvm use node
              
              # 2. åˆ¤æ–·é‚è¼¯ (é¦–æ¬¡éƒ¨ç½² vs. æ›´æ–°éƒ¨ç½²)
              if [ ! -d "$PROJECT_DIR" ]; then
                echo "--- Initial Deployment ---"
                git clone "$REPO_URL" "$PROJECT_DIR"
                cd "$PROJECT_DIR"
                npm install
                pm2 start index.js --name "$SERVICE_NAME"
                pm2 save
              else
                echo "--- Update Deployment ---"
                cd "$PROJECT_DIR"
                git pull origin main
                npm install
                pm2 reload "$SERVICE_NAME"
              fi
              echo "--- Deployment Finished ---"
              
              EOF