name: Node.js EC2 Deployment via SSM

# 當推送到 main 分支時觸發 CI/CD
on:
  push:
    branches:
      - main

# 環境變數定義
env:
  NODE_VERSION: '18.16.0'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: 檢查程式碼
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 2: 設定 Node.js 環境 (CI 環境)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    # ----------------------------------------------------
    # Step 3: 部署到 EC2 (使用 SSM Run Command)
    # ----------------------------------------------------
    - name: Deploy to EC2 via SSM
      uses: aws-actions/aws-ssm-run-command@v1
      with:
        # 傳入 GitHub Secrets 中的 AWS 憑證
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
        
        # 指定要執行指令的 EC2 實體
        instance-id: ${{ secrets.EC2_INSTANCE_ID }}
        
        # 部署指令 (這是遠端 EC2 上要執行的 bash 腳本)
        # 假設你的專案已經在 EC2 上，並且使用 PM2 管理
        command: |
          # 1. 切換到專案目錄 (請根據你的實際路徑調整)
          cd /home/ec2-user/simple_router/
          
          # 2. 拉取最新程式碼
          git pull origin main
          
          # 3. 安裝依賴 (如果 package.json 有變動)
          npm install
          
          # 4. 重新啟動 PM2 服務 (假設服務名稱是 simple-router)
          # PM2 會自動更新並重新載入服務
          pm2 reload simple-router
