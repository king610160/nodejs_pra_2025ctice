    - name: Deploy to EC2 via SSM (Using AWS CLI)
      # ⚠️ 注意：使用 aws-actions/configure-aws-credentials 進行認證
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Execute Deployment Commands on EC2
      # 這裡我們直接使用 'run' 執行 Bash 命令，而不是依賴外部 Action
      run: |
        # 準備要執行的部署腳本 (必須是單行字串或用 Bash 語法包裝)
        DEPLOY_SCRIPT="
          PROJECT_DIR='/home/ec2-user/simple_router'
          SERVICE_NAME='simple-router'
          REPO_URL='https://github.com/${{ github.repository }}.git'
          
          # 確保 NVM 環境變數生效，以便找到 pnpm 和 pm2
          source /home/ec2-user/.bashrc || true 

          if [ ! -d \"\$PROJECT_DIR\" ]; then
            echo '--- 執行首次部署 (Initial Deployment) ---'
            mkdir -p \"\$PROJECT_DIR\"
            cd \"\$PROJECT_DIR\"
            git clone \"\$REPO_URL\" .
            pnpm install
            pm2 start index.js --name \"\$SERVICE_NAME\"
            pm2 save
          else
            echo '--- 執行程式碼更新 (Update Deployment) ---'
            cd \"\$PROJECT_DIR\"
            git pull origin main
            pnpm install
            pm2 reload \"\$SERVICE_NAME\"
          fi
          echo '--- 部署完成 ---'
        "

        # 使用 AWS CLI 的 ssm send-command 服務發送腳本到 EC2
        # 'InstanceIds' 參數使用 EC2_INSTANCE_ID
        aws ssm send-command \
          --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
          --document-name "AWS-RunShellScript" \
          --parameters commands="$DEPLOY_SCRIPT" \
          --timeout-seconds 600
