name: Node.js EC2 Deployment via SSM

# ç¢ºä¿é€™éƒ¨åˆ†åœ¨æ–‡ä»¶é–‹é ­ï¼Œä¸”ç¸®æ’æ­£ç¢º
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: æª¢æŸ¥ç¨‹å¼ç¢¼ (ä¿æŒä¸è®Š)
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: èªè­‰ (ä¿æŒä¸è®Š)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ğŸŒŸ Step 3: ä½¿ç”¨ AWS å®˜æ–¹ SSM Action åŸ·è¡Œé ç«¯è…³æœ¬ (æ¥µç°¡æ›´æ–°ç‰ˆ)
      - name: Execute Update Deployment Script on EC2
        uses: aws-actions/aws-ssm-send-command@v1
        id: ssm_deploy_update
        with:
          instance-ids: '${{ secrets.EC2_INSTANCE_ID }}'
          document-name: 'AWS-RunShellScript'
          
          parameters: |
            commands: |
              PROJECT_DIR=/home/ec2-user/simple_router
              SERVICE_NAME=simple-router
              
              # --- æ¥µç°¡æ›´æ–°è…³æœ¬ (ä¸å†éœ€è¦è¤‡é›œçš„ if/else) ---
              # å¿…é ˆä½¿ç”¨ sudo -u ec2-user åŸ·è¡Œ
              sudo -u ec2-user bash << EOF
              
              # 1. NVM/Node ç’°å¢ƒè¨­ç½®
              export NVM_DIR="/home/ec2-user/.nvm"
              [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
              nvm use node
              
              # 2. åŸ·è¡Œæ›´æ–°
              echo "--- Executing Update Deployment ---"
              cd "$PROJECT_DIR"
              git pull origin main # åªåŸ·è¡Œ pull
              npm install          # é‡æ–°å®‰è£ä¾è³´
              pm2 reload "$SERVICE_NAME" # é‡è¼‰æœå‹™
              echo "--- Deployment Finished ---"
              
              EOF